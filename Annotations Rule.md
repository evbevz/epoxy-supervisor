# Правила разметки датасетов

Чтобы тратить меньше времени на разметку, иметь повторяемость разметки и при этом даннные были более точные нетобходимо соблюдать несколько правил при подготовке датасетов.
Решил их отразить в виде рассуждений здесь.

Подготовка
----------
Разметку осуществляем в CVAT. Для каждого нового положения камеры (меняем ракурс, крепеж для инижектора и камеры и пр.) стоит создавать новый проект. И датасеты создавать уже в этом проекте в виде отдельных Task. Таким образом набор типов разметочных данных (Например то, что размечаем отдельно инжектор типом обрамляющего прямоугольника, центральную ось инжектора в виде полилинии из 20 сегментов, и большую и малые оси эллипса сечения уровня эпоксидки в виде отдельного объекта с типом skeleton) будет один раз определен для всего проекта и создании там Task будет использовать именно его.
В названии Task указывать номер проекта/камеры, последовательный номер Task (т.к. одних данных о количестве кадров в датасете может быть не достасточно).

Самым первым датасетом должнен стать датасет для создания полилинии центральной оси.
------------------------------------------------------------------------------------
Этот датасет необходимо создать с слабоподкрашенной жидкостью, чтобы на просвет хорошо была видна дальняя дуга эллипса (сечения плоскости дальней части инжектора). Но при этом не просто воду, т.к. с ней тоже не очень хорошо видна линия сечения из-за похожести с преломлением лучей через пластик. А так же этот небольшой датасет (с "правильным" цветом жидкости) в том числе можно будет использовать для обучения модели.
При этом освещение должно быть хорошим (основная задача сделать разметку центральной оси, а не обучить модель на разных данных), чтоб как можно точнее сделать разметку.
Инжектор долен занимать вертикальное положение (запускать, двигать и наклонять роборуку не требуется), плотно установлен в своё крепление (как и камера), без закрывающих поле обзора предметов (стяжки, резинки и пр.)
Заполнять инжектор жидкостью чуть больше 20мл, запустить запись видео до полного опустошения инжектора.
Из видео необходимо сделать не меньше 20 кадров с прохождением ближайшей дуги эллипса через риски шприца. Но лучше сделать больше - 80-100, чтобы уже на этапе разметки выбрать нужные кадры и точнее зафиксировать токи положения уровня эпоксидки и как следствие центра эллипса на каждом уровне.

При разметке калибровочного датасета сначала размечаются кадр фигурой типа Ellipse (в режиме Track) на первом кадре с положением истиного уровня жидкости 20мл
Затем находится последний кадр с пустым положеним инжектора и фигура Ellipse двигается и масштабируется на своё место.
Промежуточные кадры приблизительно автоматически будут поставлены на своё место.
Затем необходимо разметить (уточнить положение и масштаб) на кадре с истинным уроынем жидкости в 10мл. Опять же положение эллипса на промежуточных кадрах подвинется автоматически.
В дальнейшем так же методом деления пополам разметить (актуализировать) остальные кадры, чтобы были точные положения эллипса на уровнях равным ровным значениям 0,1,2,... 20мл.

Далее можно визуально на первом кадре датасета построить полилинию из 20 сегментов с точками в центрах эллипсов. Но центры не очень удобно расматривать и стоит тогда строить линии большой и малых осей каждого эллипса, чтобы найти пересечение.

Но предлагаю следующий метод.

Из датасета удаляются все лишние кадры (frames), кроме кадров с положениями уровней в ровных значениях 0,1,2...20мл.
Создаем полилинию на первом кадре в режиме Track, но в любом месте кадра и не расставляем токи по своим местам.
Затем делается выгрузка анотации в формате CVAT 1.1.
В этом файле для каждого кадра будет указан центр эллипса в виде такой записи

    <ellipse label="ellipse" source="manual" occluded="0" cx="926.33" cy="1104.37" rx="116.46" ry="84.59" rotation="16.00" z_order="0">
    </ellipse>

Где значения cx, cy - и есть наши искомые центры эллипсов на нужных уровнях.

Далее необходимо в строках файла с форматом ниже заменить значения в points на значения cx,cy из тегов <ellipse label="ellipse"> от кадров с 0 по 21 (0 - 20 мл)
    <polyline label="centroid axis" source="manual" occluded="0" points="926.10,1104.60;948.60,1034.50;971.80,964.30;993.80,894.70;1015.80,824.80;1033.30,768.50;1043.00,704.70;1063.60,588.90;1065.50,476.90;1052.70,372.20;1040.20,266.30;1027.50,160.50" z_order="0">
    </polyline>
Это необходимо сделать в файле 21 раз (столько кадров размечено)
